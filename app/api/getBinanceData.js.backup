// planToAchieveProfitTarget_v2.js
import { z } from 'zod';

// 辅助函数：从 Binance 公共接口获取最新价格
async function fetchBinancePrice(symbol) {
  try {
    // 自动处理 BTC -> BTCUSDT
    const pair = symbol.toUpperCase().endsWith('USDT') ? symbol.toUpperCase() : `${symbol.toUpperCase()}USDT`;
    const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${pair}`);
    const data = await response.json();
    
    if (!data.price) throw new Error('Price not found');
    return parseFloat(data.price);
  } catch (error) {
    // 如果抓取失败（例如网络问题），返回 null，让主程序报错提示用户手动输入
    console.error("Failed to fetch price:", error);
    return null;
  }
}

export const planToAchieveProfitTarget = tool({
  description: `Generate BTC/ETH strategies with real-time price lookup.`,

  inputSchema: z.object({
    symbol: z.enum(['BTC', 'ETH', 'SOL', 'BNB']).default('BTC'),
    
    // 变为可选 (Optional)。如果不填，工具会自动去查。
    currentPrice: z.number().positive().optional().describe('如果不填，系统将自动从 Binance 获取最新价格'),
    
    // 持仓信息依然需要手动输入 (安全起见)
    position: z.object({
      direction: z.enum(['long', 'short']),
      avgPrice: z.number().positive(),
      qty: z.number().positive(),
      leverage: z.number().default(10),
    }),

    targetProfitMYR: z.number().nonnegative(),
    conservativeMode: z.boolean().default(true)
  }),

  execute: async (params) => {
    try {
      let marketPrice = params.currentPrice;

      // 1. 如果用户没给价格，自动去 Binance 查
      if (!marketPrice) {
        console.log(`正在从 Binance 获取 ${params.symbol} 实时价格...`);
        const livePrice = await fetchBinancePrice(params.symbol);
        
        if (livePrice) {
          marketPrice = livePrice;
        } else {
          return { error: "无法获取实时价格，请手动输入 'currentPrice'。" };
        }
      }

      // ... (接下来的逻辑与之前的 5 大策略代码完全一致，使用 marketPrice 进行计算) ...
      
      // 在返回结果里标记一下价格来源
      const priceSource = params.currentPrice ? "User Input" : "Binance Live API";

      return {
        meta: { 
          symbol: params.symbol, 
          priceUsed: marketPrice, 
          source: priceSource 
        },
        // ... 策略结果
      };

    } catch (error) {
      return { error: error.message };
    }
  }
});