// planToAchieveProfitTarget.js
// Tool: planToAchieveProfitTarget
// Purpose: Generate specific crypto trading actions (10x Add, Spot Buy, Hedge, etc.) to hit target P&L
// Context: Optimized for BTC/ETH high volatility environment

import { z } from 'zod';

export const planToAchieveProfitTarget = tool({
  description: `ä¸º BTC/ETH äº¤æ˜“ç”Ÿæˆ 5 å¤§ç±»æ“ä½œç­–ç•¥ï¼Œä»¥è¾¾æˆé¢„è®¾ç›ˆåˆ©ç›®æ ‡ã€‚
  è€ƒè™‘äº† 10x åˆçº¦æ æ†ã€ç°è´§ä¹°å…¥ã€æ™ºèƒ½å¯¹å†²ä»¥åŠç›ˆåˆ©ä¸´ç•Œç‚¹çš„ç‰¹æ®Šå¤„ç†ã€‚`,

  inputSchema: z.object({
    symbol: z.enum(['BTC', 'ETH', 'OTHER']).default('BTC').describe('äº¤æ˜“å¯¹'),
    currentPrice: z.number().positive().describe('å½“å‰å¸‚åœºä»·æ ¼'),
    
    // æŒä»“è¯¦æƒ…
    position: z.object({
      direction: z.enum(['long', 'short']).describe('å½“å‰æŒä»“æ–¹å‘'),
      avgPrice: z.number().positive().describe('æŒä»“å‡ä»·'),
      margin: z.number().positive().describe('å½“å‰æŠ•å…¥çš„ä¿è¯é‡‘(Principal)'),
      leverage: z.number().default(10).describe('å½“å‰æŒä»“æ æ†å€æ•°ï¼Œé»˜è®¤ 10x'),
      qty: z.number().positive().describe('æŒä»“æ•°é‡ (ä¾‹å¦‚ BTC ä¸ªæ•°ï¼Œä¸æ˜¯åˆçº¦å¼ æ•°)') 
    }),

    targetProfitMYR: z.number().nonnegative().describe('ç›®æ ‡ç›ˆåˆ©é‡‘é¢ (MYR/USDT)'),
    maxAdditionalCapital: z.number().optional().describe('æœ€å¤§å¯è¿½åŠ èµ„é‡‘é™åˆ¶'),
    
    // æ¨¡å¼è®¾ç½®
    conservativeMode: z.boolean().default(true).describe('æ˜¯å¦å¼€å¯ä¿å®ˆæ¨¡å¼ï¼ˆå½±å“åŠ ä»“ä½ç½®ä¼°ç®—ï¼‰')
  }),

  execute: async (params) => {
    try {
      const { symbol, currentPrice, position, targetProfitMYR, conservativeMode } = params;
      const leverage = position.leverage || 10;
      
      // 1. åŸºç¡€æ•°æ®è®¡ç®— (Base Stats)
      // å½“å‰æŒä»“æ€»ä»·å€¼ (Notional Value)
      const totalNotional = position.qty * position.avgPrice; 
      
      // æ–¹å‘ç³»æ•°: 1 for Long, -1 for Short
      const dir = position.direction === 'long' ? 1 : -1;
      
      // å½“å‰æœªç»“ç›ˆäº (Unrealized PnL)
      // Long: (Curr - Avg) * Qty
      // Short: (Avg - Curr) * Qty
      const currentPnl = (currentPrice - position.avgPrice) * position.qty * dir;
      
      // è·ç¦»ç›®æ ‡çš„å·®è·
      const pnlDiff = targetProfitMYR - currentPnl;

      // ---------------------------------------------------------
      // ç­–ç•¥ 5: ç›ˆåˆ©é€¼è¿‘ç›®æ ‡ç‚¹ (Close to Target)
      // ---------------------------------------------------------
      // å¦‚æœå½“å‰ç›ˆåˆ©å·²ç»è¾¾åˆ°ç›®æ ‡çš„ 85% ä»¥ä¸Šï¼Œæˆ–è€…å·²ç»è¶…é¢
      if (pnlDiff <= 0 || currentPnl >= targetProfitMYR * 0.85) {
        const actionType = pnlDiff <= 0 ? "TARGET_MET" : "NEAR_TARGET";
        const closePrice = position.direction === 'long' 
          ? position.avgPrice + (targetProfitMYR / position.qty)
          : position.avgPrice - (targetProfitMYR / position.qty);

        return {
          status: actionType,
          currentPnl: currentPnl.toFixed(2),
          targetPnl: targetProfitMYR,
          gap: pnlDiff.toFixed(2),
          strategies: [{
            id: 5,
            title: pnlDiff <= 0 ? "ğŸ‰ ç›®æ ‡å·²è¾¾æˆ (Target Met)" : "ğŸ¯ ç›ˆåˆ©é€¼è¿‘ç›®æ ‡ (Near Target)",
            type: 'limit_close',
            action: `ç«‹å³æŒ‚å•å¹³ä»“ (Limit Close Order)`,
            limitPrice: closePrice.toFixed(2),
            description: pnlDiff <= 0 
              ? `å½“å‰ç›ˆåˆ©å·²è¦†ç›–ç›®æ ‡ã€‚å»ºè®®ç«‹å³æ­¢ç›ˆæˆ–è®¾ç½®ç§»åŠ¨æ­¢æŸã€‚`
              : `å½“å‰ç›ˆåˆ©å·²è¾¾ç›®æ ‡çš„ ${(currentPnl/targetProfitMYR*100).toFixed(1)}%ã€‚å»ºè®®åœ¨ ${closePrice.toFixed(2)} æŒ‚å•ï¼Œä¸è¦åŠ ä»“å¢åŠ é£é™©ã€‚`
          }]
        };
      }

      const strategies = [];

      // ---------------------------------------------------------
      // ç­–ç•¥ 1: åŠ ä»“ç­–ç•¥ (10x æ æ†) - Aggressive Recovery
      // ---------------------------------------------------------
      // é€»è¾‘ï¼šåˆ©ç”¨ 10x æ æ†ï¼Œç”¨è¾ƒå°‘èµ„é‡‘å¤§å¹…æ‹‰ä½å‡ä»·ã€‚
      // å‡è®¾åœ¨å½“å‰ä»·æ ¼ (æˆ–ç•¥ä½) åŠ ä»“
      const addPrice = conservativeMode ? currentPrice * 0.995 : currentPrice; 
      
      // è®¡ç®—ï¼šéœ€è¦åŠ å¤šå°‘ä»“ä½(Qty)ï¼Œæ‰èƒ½åœ¨ä»·æ ¼å›åˆ° "å¾®åå¼¹" ä½ç½®æ—¶è¾¾æˆç›®æ ‡ï¼Ÿ
      // ç®€åŒ–æ¨¡å‹ï¼šæˆ‘ä»¬è¦è®© æ–°çš„æŒä»“ åœ¨ ä»·æ ¼ = currentPrice * 1.01 (å¾®æ¶¨) æ—¶è¾¾æˆ targetProfit
      // è¿™ç§è®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬ç”¨æ›´ç›´è§‚çš„é€»è¾‘ï¼š
      // "å¡«è¡¥ PnL ç¼ºå£éœ€è¦å¤šå°‘é¢å¤–ä»“ä½äº§ç”Ÿçš„åˆ©æ¶¦ï¼Ÿ"
      // å‡è®¾æˆ‘ä»¬è¦é€šè¿‡åŠ ä»“ï¼ŒæŠŠæ•´ä½“å‡ä»·æ‹‰åˆ° currentPrice é™„è¿‘ã€‚
      
      // è¿™é‡Œä½¿ç”¨"ç›®æ ‡å¹³æ‘Šæ³•"ï¼š
      // æ±‚è§£ Qty_addï¼Œä½¿å¾— (TargetPrice - NewAvg) * (Qty_old + Qty_add) = TargetPnL
      // è®¾å®š TargetPrice ä¸ºç”¨æˆ·å®¹æ˜“è¾¾åˆ°çš„ä»·æ ¼ï¼ˆä¾‹å¦‚å½“å‰ä»·æ ¼+1%ï¼‰
      const recoveryTargetPrice = position.direction === 'long' 
        ? currentPrice * 1.015 
        : currentPrice * 0.985;

      function calculateRequiredQty(targetPrice) {
        // PnL_new = (targetPrice - newAvg) * (totalQty) * dir
        // å±•å¼€åï¼š PnL_new = (targetPrice * totalQty - totalInvested) * dir
        // totalInvested = (oldQty * oldAvg) + (addQty * addPrice)
        // TargetPnL = [targetPrice * (oldQty + addQty) - (oldQty*oldAvg + addQty*addPrice)] * dir
        // è§£æ–¹ç¨‹æ±‚ addQty
        
        // Long: TargetPnL = (targetPrice - addPrice)*addQty + (targetPrice*oldQty - oldQty*oldAvg)
        // Short: TargetPnL = (oldQty*oldAvg + addQty*addPrice) - targetPrice*(oldQty + addQty)
        
        let addQty = 0;
        if (position.direction === 'long') {
           const profitFromOld = (targetPrice - position.avgPrice) * position.qty;
           const remainder = targetProfitMYR - profitFromOld;
           const profitPerUnitNew = targetPrice - addPrice;
           if (profitPerUnitNew <= 0) return Infinity; // åŠ ä»“ä»·é«˜äºç›®æ ‡ä»·ï¼Œæ— æ³•è·åˆ©
           addQty = remainder / profitPerUnitNew;
        } else {
           // Short
           const profitFromOld = (position.avgPrice - targetPrice) * position.qty;
           const remainder = targetProfitMYR - profitFromOld;
           const profitPerUnitNew = addPrice - targetPrice;
           if (profitPerUnitNew <= 0) return Infinity;
           addQty = remainder / profitPerUnitNew;
        }
        return addQty;
      }

      const qtyLev = calculateRequiredQty(recoveryTargetPrice);
      
      if (qtyLev > 0 && isFinite(qtyLev)) {
        const marginRequired = (qtyLev * addPrice) / 10; // 10x Leverage
        strategies.push({
          id: 1,
          title: `ğŸ”¥ 10x æ æ†åŠ ä»“ (${symbol} 10x Add)`,
          type: 'leverage_add',
          action: position.direction === 'long' ? 'Long Buy' : 'Short Sell',
          quantity: qtyLev.toFixed(4),
          price: addPrice.toFixed(2),
          requiredCapital: marginRequired.toFixed(2),
          note: `ä½¿ç”¨ 10x æ æ†ã€‚åªè¦ä»·æ ¼åå¼¹è‡³ ${recoveryTargetPrice.toFixed(2)} å³å¯è¾¾æˆç›®æ ‡ã€‚`,
          risk: 'High - æ³¨æ„çˆ†ä»“ä»·æ ¼å˜åŒ–'
        });
      }

      // ---------------------------------------------------------
      // ç­–ç•¥ 2: ä¹°ç°è´§ (Spot Buy) - Conservative / Funding
      // ---------------------------------------------------------
      // é€»è¾‘ï¼šä¹°å…¥ç°è´§ï¼Œä¸åŠ æ æ†ã€‚è¿™é€šå¸¸ç”¨äºï¼š
      // 1. é™ä½æ•´ä½“èµ„äº§é£é™©ï¼ˆç°è´§ä¸ä¼šçˆ†ä»“ï¼‰ã€‚
      // 2. é•¿æœŸçœ‹å¥½ï¼Œè¶ä½å¸çº³ï¼Œç”¨ç°è´§çš„æ¶¨å¹…æ¥å¼¥è¡¥åˆçº¦çš„äºæŸã€‚
      // è®¡ç®—ï¼šå‡è®¾ç°è´§æ¶¨å¹…è´¡çŒ® PnL ç¼ºå£ã€‚
      
      // æˆ‘ä»¬å‡è®¾ç°è´§ç›®æ ‡å‡ºåœºä»·ä¸åˆçº¦ç­–ç•¥ä¸€è‡´
      const qtySpot = calculateRequiredQty(recoveryTargetPrice);
      
      if (qtySpot > 0 && isFinite(qtySpot)) {
        const cashRequired = qtySpot * addPrice; // 1x Leverage (Real Money)
        strategies.push({
          id: 2,
          title: `ğŸ›¡ï¸ ä¹°å…¥ç°è´§ (Buy Spot)`,
          type: 'spot_buy',
          action: 'Spot Buy',
          quantity: qtySpot.toFixed(4),
          price: addPrice.toFixed(2),
          requiredCapital: cashRequired.toFixed(2), // Full amount
          note: `ä½¿ç”¨ 1:1 å®ç›˜èµ„é‡‘ä¹°å…¥ã€‚æ— çˆ†ä»“é£é™©ï¼Œé€‚åˆé•¿æœŸæŒæœ‰ç­‰å¾…åå¼¹ã€‚`,
          risk: 'Low'
        });
      }

      // ---------------------------------------------------------
      // ç­–ç•¥ 3: å¯¹å†²ç­–ç•¥ (Hedging)
      // ---------------------------------------------------------
      // é€»è¾‘ï¼šå½“å‰æŒä»“å¦‚æœäºæŸä¸¥é‡ï¼ˆæ–¹å‘åäº†ï¼‰ï¼Œåˆ™å¼€åå‘å•ã€‚
      // å¦‚æœæ˜¯ Longï¼Œåˆ™ Open Shortï¼›å¦‚æœæ˜¯ Shortï¼Œåˆ™ Open Longã€‚
      // ç›®æ ‡ï¼šé€šè¿‡æ³¢åŠ¨ç‡èµšé’±ï¼Œæˆ–è€…é”ä½äºæŸä¸å†æ‰©å¤§ã€‚
      
      const hedgeDir = position.direction === 'long' ? 'short' : 'long';
      // å‡è®¾å¯¹å†²å•çš„ç›®æ ‡æ˜¯æ•æ‰ä¸‹ä¸€æ¬¡è¶‹åŠ¿ï¼ˆå‡è®¾é€†åŠ¿å»¶ç»­ï¼‰
      // è®¾å®šå¯¹å†²æ­¢ç›ˆç›®æ ‡ï¼šå½“å‰ä»·æ ¼å†è·Œ/æ¶¨ 2%
      const hedgeTargetPrice = hedgeDir === 'short' 
        ? currentPrice * 0.98 
        : currentPrice * 1.02;
        
      // è®¡ç®—éœ€è¦å¤šå°‘ä»“ä½ï¼Œåœ¨è¿™ä¸ª 2% çš„æ³¢åŠ¨ä¸­èµšå› pnlDiff
      // PnL_Hedge = qty * |Entry - Target|
      const priceDelta = Math.abs(currentPrice - hedgeTargetPrice);
      const qtyHedge = pnlDiff / priceDelta;
      const hedgeMargin = (qtyHedge * currentPrice) / 10; // 10x Hedge

      strategies.push({
        id: 3,
        title: `âš–ï¸ å¯¹å†²ç­–ç•¥ (Smart Hedge)`,
        type: 'hedge',
        action: hedgeDir === 'short' ? 'Open Short (10x)' : 'Open Long (10x)',
        quantity: qtyHedge.toFixed(4),
        requiredCapital: hedgeMargin.toFixed(2),
        targetPrice: hedgeTargetPrice.toFixed(2),
        note: `å‡è®¾åŸæœ‰æŒä»“ç»§ç»­äºæŸï¼Œåˆ©ç”¨åå‘å•åœ¨ ${hedgeTargetPrice.toFixed(2)} å¤„èµšå›ç›®æ ‡åˆ©æ¶¦ã€‚`,
        risk: 'Medium - éœ€è¦æ‰‹åŠ¨ç®¡ç†ä¸¤è¾¹ä»“ä½'
      });

      // ---------------------------------------------------------
      // ç­–ç•¥ 4: æ··åˆæ“ä½œ (Mixed Action)
      // ---------------------------------------------------------
      // é€»è¾‘ï¼š50% èµ„é‡‘åš 10x åŠ ä»“ï¼ˆè¿›æ”»ï¼‰ï¼Œ50% èµ„é‡‘åšå¯¹å†²ï¼ˆé˜²å®ˆï¼‰ã€‚
      // æˆ–è€… èµ„é‡‘æœ‰é™æƒ…å†µä¸‹ï¼Œä¸€åŠç›®æ ‡ç”±åŠ ä»“å®Œæˆï¼Œä¸€åŠç”±å¯¹å†²å®Œæˆã€‚
      
      const mixAddQty = qtyLev / 2;
      const mixHedgeQty = qtyHedge / 2;
      const mixCapital = (mixAddQty * addPrice / 10) + (mixHedgeQty * currentPrice / 10);

      strategies.push({
        id: 4,
        title: `ğŸ¹ æ··åˆç­–ç•¥ (Mixed Action)`,
        type: 'mixed',
        composition: [
          { action: position.direction === 'long' ? 'Add Long' : 'Add Short', qty: mixAddQty.toFixed(4) },
          { action: hedgeDir === 'short' ? 'Open Short' : 'Open Long', qty: mixHedgeQty.toFixed(4) }
        ],
        requiredCapital: mixCapital.toFixed(2),
        note: `åŒå‘æ“ä½œã€‚é™ä½å•ä¸€æ–¹å‘é£é™©ï¼Œåœ¨éœ‡è¡è¡Œæƒ…ä¸­é€šè¿‡ç½‘æ ¼äº¤æ˜“é€æ­¥å›æœ¬ã€‚`,
        risk: 'Medium'
      });

      return {
        symbol,
        currentStatus: {
          price: currentPrice,
          pnl: currentPnl.toFixed(2),
          gap: pnlDiff.toFixed(2)
        },
        strategies
      };

    } catch (error) {
      return { error: error.message };
    }
  }
});