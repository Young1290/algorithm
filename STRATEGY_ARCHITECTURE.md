# 策略架构说明

**更新时间**: 2025-11-21  
**版本**: v3.1  
**状态**: ✅ 已完成

---

## 🎯 核心概念

### 策略 vs 法则

- **策略 (Strategy)**: 交易动作/方向（加仓、对冲、现货、混合）
- **法则 (Method)**: 执行方式（金字塔、马丁格尔）

**重要**: 金字塔和马丁格尔是**法则**，不是策略本身！

---

## 📊 4个核心策略

### 1. 🔥 继续加仓 (10x 杠杆)
- **动作**: 同向加仓，拉低均价
- **默认法则**: 金字塔法则（推荐）
- **备选法则**: 马丁格尔法则（高风险，不单独推荐）

**金字塔法则执行**:
- 分3批建仓：20% / 30% / 50%
- 价格梯队：现价 / -1.5% / -4.0%
- 风险分散，推荐使用

**马丁格尔法则执行**:
- 一次性加仓
- 快速拉低均价
- 风险集中，仅作备选

---

### 2. ⚖️ 做对冲 (10x 杠杆)
- **动作**: 反向开单，锁定风险
- **目标**: 利用波动赚取差价
- **特点**: 风险锁定，不会爆仓

---

### 3. 🛡️ 买现货 (Spot)
- **动作**: 全额买入现货
- **杠杆**: 1x（无杠杆）
- **特点**: 无爆仓风险，适合长期持有

---

### 4. 🍹 混合策略 (10x 杠杆)
- **动作**: 半仓加仓 + 半仓对冲
- **特点**: 平衡风险与收益
- **条件**: 仅当策略1和策略2都可行时生成

---

## 🏗️ 模块化架构

```
app/lib/
├── strategy-engine.ts          # 主引擎（协调器）
│   ├── generateStrategies()    # 生成4个策略
│   └── formatStrategyOutput()  # 格式化输出
│
└── strategies/                 # 法则模块
    ├── pyramid-strategy.ts     # 🔺 金字塔法则
    │   └── createPyramidPlan() # 生成分批计划
    │
    └── martingale-strategy.ts  # 🎲 马丁格尔法则
        └── createMartingalePlan() # 生成一次性计划
```

---

## 📋 策略生成流程

```typescript
// 1. 策略1：继续加仓（默认使用金字塔法则）
if (qtyPyramid > 0) {
  const pyramidPlan = createPyramidPlan('buy', currentPrice, qtyPyramid, 10);
  strategies.push({
    id: 1,
    title: '🔥 继续加仓 (10x) - 金字塔法则',
    strategyMethod: 'pyramid',
    isGrid: true,
    gridOrders: pyramidPlan.orders, // 分批订单
    // ...
  });
}

// 2. 策略2：做对冲
strategies.push({
  id: 2,
  title: '⚖️ 做对冲 (10x)',
  // ...
});

// 3. 策略3：买现货
strategies.push({
  id: 3,
  title: '🛡️ 买现货 (Spot)',
  // ...
});

// 4. 策略4：混合策略（条件生成）
if (has策略1 && has策略2) {
  strategies.push({
    id: 4,
    title: '🍹 混合策略 (10x)',
    // ...
  });
}
```

---

## 🔺 金字塔法则详解

### 仓位分配
```
批次1: 20% - 🔹 底仓（现价）
批次2: 30% - 🔸 支撑补单（-1.5%）
批次3: 50% - 🔶 黄金坑（-4.0%）
```

### 示例输出

```markdown
**📊 金字塔分批计划**

| 批次 | 买入挂单价格 | 数量 (BTC) | 所需本金 | 说明 |
|------|----------------|-----------|---------|------|
| 1 | $83,338.80 | 2.8700 | $23,914.21 | 🔹 底仓 (20%) |
| 2 | $82,088.72 | 4.3050 | $35,343.31 | 🔸 支撑补单 (30%) |
| 3 | $80,005.44 | 7.1750 | $57,403.90 | 🔶 黄金坑 (50%) |
```

### 优势
- ✅ 风险分散
- ✅ 成本平滑
- ✅ 心理压力小
- ✅ 适合震荡市

---

## 🎲 马丁格尔法则详解

### 执行方式
- 一次性加仓全部数量
- 在单一价格点位执行

### 特点
- ⚠️ 风险集中
- ⚠️ 快速见效
- ⚠️ 心理压力大
- ⚠️ 适合单边市

### 使用建议
- 不单独推荐
- 仅作为金字塔法则的备选
- 用户可在金字塔策略基础上选择改用马丁格尔执行

---

## 📊 输出格式

### 策略1（金字塔法则）

```markdown
#### ✅ 推荐 | 🔥 继续加仓 (10x) - 金字塔法则

- **动作**: Buy Long 14.3500 BTC
- **所需本金 (Margin)**: **$118,845** (10x 杠杆)
- **执行价格**: Avg $82,814.71
- **止盈目标**: **$84,630.11**

**📊 金字塔分批计划**

| 批次 | 买入挂单价格 | 数量 (BTC) | 所需本金 | 说明 |
|------|----------------|-----------|---------|------|
| 1 | $83,338.80 | 2.8700 | $23,914.21 | 🔹 底仓 (20%) |
| 2 | $82,088.72 | 4.3050 | $35,343.31 | 🔸 支撑补单 (30%) |
| 3 | $80,005.44 | 7.1750 | $57,403.90 | 🔶 黄金坑 (50%) |

- **新强平价**: **$1,199.45**
- **建议止损**: **$82,700.67**
- **详情**: 采用金字塔法则，分 3 批建仓（20%/30%/50%），在不同价格点位逐步加仓，有效降低平均成本，同时控制单次风险。
```

---

## ✅ 测试结果

```
✅ 收到 4 个策略

策略列表：
  1. 🔥 继续加仓 (10x) - 金字塔法则 (金字塔)
  2. ⚖️ 做对冲 (10x) 
  3. 🛡️ 买现货 (Spot) 
  4. 🍹 混合策略 (10x)
```

---

## 🎯 设计原则

1. **策略是动作，法则是方法**
   - 策略：做什么（加仓、对冲、现货、混合）
   - 法则：怎么做（金字塔、马丁格尔）

2. **金字塔优先**
   - 默认推荐金字塔法则
   - 马丁格尔作为备选，不单独推荐

3. **模块化设计**
   - 策略和法则分离
   - 易于维护和扩展

4. **用户友好**
   - 清晰的策略分类
   - 详细的风险提示
   - 直观的分批计划表格

---

*最后更新: 2025-11-21*  
*维护者: AI Assistant*  
*状态: ✅ 生产就绪*
