# Bitcoin Trading Strategy Engine - 完整文档

> 比特币交易策略引擎 - AI驱动的交易分析助手
> 
> **最后更新**: 2025-11-20  
> **版本**: 2.0  
> **状态**: ✅ 生产就绪

---

## 📋 目录

1. [快速开始](#快速开始)
2. [核心功能](#核心功能)
3. [策略引擎](#策略引擎)
4. [计算规则](#计算规则)
5. [API 使用](#api-使用)
6. [调试指南](#调试指南)
7. [风控系统](#风控系统)

---

## 🚀 快速开始

### 安装和运行

```bash
# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env 添加你的 DEEPSEEK_API_KEY

# 启动开发服务器
npm start

# 在浏览器中打开
# Web: http://localhost:8081
# 或使用 Expo Go 扫描二维码
```

### 项目结构

```
bc/
├── app/
│   ├── api/
│   │   └── chat+api.ts          # AI 聊天 API 端点
│   ├── lib/
│   │   ├── strategy-engine.ts   # 策略引擎核心
│   │   └── bitcoin-trading.ts   # 交易计算工具
│   └── (tabs)/                  # UI 界面
├── docs/
│   └── README.md                # 本文档
└── .env                         # 环境配置
```

---

## 💡 核心功能

### 1. 实时市场数据
- 🔄 从 Binance API 获取实时 BTC 价格
- 📊 24小时市场统计（最高/最低/成交量）
- 💰 所有价格单位：**USD**

### 2. AI 驱动分析
- 🤖 DeepSeek AI 模型
- 🛠️ 5个专业交易工具
- 📈 自动调用正确的计算工具

### 3. 策略生成引擎
- 🔥 10x 杠杆加仓策略
- 🛡️ 现货买入策略
- ⚖️ 对冲策略
- 🍹 混合策略
- 🎯 止盈建议

### 4. 风险评估系统
- ✅ 60% 安全水位线
- ⚠️ 资金占用率检查
- ☠️ 爆仓价预警
- 🚫 资金不足提示

---

## 🎯 策略引擎

### 策略类型

#### Strategy 1: 🔥 10x 杠杆加仓
- **特点**: 使用10倍杠杆降低均价
- **资金效率**: 高（仅需本金的10%）
- **风险**: 高（有爆仓风险）
- **适用**: 看好短期反弹

#### Strategy 2: 🛡️ 现货买入
- **特点**: 1:1 全额买入，无杠杆
- **资金效率**: 低（需要全额资金）
- **风险**: 低（无爆仓风险）
- **适用**: 长期持有

#### Strategy 3: ⚖️ 对冲策略
- **特点**: 反向开单，利用波动赚差价
- **资金效率**: 中等
- **风险**: 中等
- **适用**: 震荡市场

#### Strategy 4: 🍹 混合策略
- **特点**: 半仓加仓 + 半仓对冲
- **资金效率**: 中等
- **风险**: 平衡
- **适用**: 不确定方向时

#### Strategy 5: 🎉 目标达成
- **触发**: 当前盈利 ≥ 目标的85%
- **建议**: 立即止盈或挂单离场
- **风险**: 最低

### 输入参数

```typescript
{
  symbol: "BTC",                    // 交易对
  currentPrice?: number,            // 当前价格（可选，自动获取）
  position: {
    direction: "long" | "short",    // 方向
    avgPrice: number,               // 平均入场价 (USD)
    qty: number,                    // 持仓数量（已杠杆）
    leverage: 10                    // 杠杆倍数
  },
  account?: {                       // 账户信息（可选）
    availableBalance: number,       // 可用余额 (USD)
    totalWalletBalance: number      // 总权益 (USD)
  },
  targetProfitUSD: number,          // 目标盈利 (USD)
  conservativeMode: true            // 保守模式
}
```

### 输出示例

```markdown
## 📊 策略引擎分析报告 (10x 模式)

### 1. 账户持仓诊断
> **当前市价**: $91,970
> **当前盈亏**: $8,635
> **持仓总量 (名义)**: $800,000
> **占用本金 (估算)**: $80,000

### 2. 建议行动方案 (基于 60% 风控线)

#### ✅ 推荐 (安全) | 🔥 10x 杠杆加仓
> **💡 风控评估**: 总资金占用 38.6%，处于 60% 安全线内。

- **动作**: Buy Long 75.8 BTC
- **所需本金 (Margin)**: **$693,384** (10x 杠杆)
- *操控名义价值*: $6,933,840
- **执行价格**: $91,516
- **详情**: 价格微弹至 $93,309 即可达标。
```

---

## 📐 计算规则

### 核心规则：盈利百分比计算

**重要**: 当用户提到盈利百分比时，**始终基于已投入资金计算**，而非账户总余额。

#### 公式

```
目标盈利金额 = 已投入资金 × 盈利百分比
```

#### 示例

**场景**: 用户说"我总资金2,000,000，在90,000买了300,000仓位，92,000买了500,000仓位。我想盈利20%。"

**正确计算**:
```
已投入 = 300,000 + 500,000 = 800,000
目标盈利 = 800,000 × 20% = 160,000 ✅
```

**错误计算**:
```
目标盈利 = 2,000,000 × 20% = 400,000 ❌
```

**原因**: 
- 2,000,000 是总资金（包括未使用的余额）
- 实际投入交易的只有 800,000
- ROI 应该基于实际投入的资金

### 单位标准

所有金额单位统一为 **USD (美元)**:
- ✅ 价格: USD
- ✅ 账户余额: USD/USDT
- ✅ 盈亏: USD
- ✅ 保证金: USD
- ✅ Binance API 返回: USD

---

## 🔧 API 使用

### 聊天 API

**端点**: `POST /api/chat`

**请求体**:
```json
{
  "messages": [
    {
      "role": "user",
      "parts": [
        {
          "type": "text",
          "text": "我在10万美元买了0.5个BTC，现在价格是9.5万，我想达到5000美元盈利，给我策略建议。我的账户余额是2万美元，总权益是3万美元。"
        }
      ]
    }
  ],
  "language": "zh"
}
```

**响应**: Server-Sent Events (SSE) 流式响应

### 可用工具

#### 1. `analyzeTradePosition`
分析持仓的盈亏、平均价格等。

#### 2. `calculateTargetPrices`
计算达到特定收益率所需的价格。

#### 3. `suggestPositionAdjustment`
建议对冲或加仓策略。

#### 4. `getBinanceMarketData`
获取实时市场数据。

#### 5. `planToAchieveProfitTarget` ⭐
**最常用**: 生成达成盈利目标的策略方案。

---

## 🐛 调试指南

### 常见问题

#### 问题 1: AI 不调用工具

**症状**: AI 手动计算而不是调用工具

**解决方案**:
1. 检查 system prompt 是否包含强制规则
2. 确认示例格式正确
3. 查看日志: `🔧 [toolName] called with:`

**验证**:
```bash
# 检查日志
grep "tool-call" logs.txt

# 应该看到:
# 🔧 planToAchieveProfitTarget called with: {...}
# ✅ planToAchieveProfitTarget completed successfully
```

#### 问题 2: 工具参数错误

**症状**: 工具调用失败或返回错误

**解决方案**:
1. 检查参数类型是否正确
2. 确认必填字段都已提供
3. 验证数值范围（如价格 > 0）

#### 问题 3: 计算结果不符合预期

**症状**: 策略建议的金额或数量不对

**解决方案**:
1. 确认输入的 `qty` 是杠杆后的数量
2. 检查 `avgPrice` 计算是否正确
3. 验证 `targetProfitUSD` 是否基于已投入资金

### 测试命令

```bash
# 测试基本功能
curl -X POST http://localhost:8081/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{
      "role": "user",
      "parts": [{
        "type": "text",
        "text": "BTC现在多少钱？"
      }]
    }],
    "language": "zh"
  }'

# 测试策略生成
curl -X POST http://localhost:8081/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{
      "role": "user",
      "parts": [{
        "type": "text",
        "text": "我在10万美元买了0.5个BTC，现在价格是9.5万，我想达到5000美元盈利，给我策略建议。账户余额2万美元，总权益3万美元。"
      }]
    }],
    "language": "zh"
  }'
```

---

## 🛡️ 风控系统

### 60% 安全水位线

系统会自动评估每个策略的资金占用率：

```
总占用率 = (当前已用保证金 + 策略新增保证金) / 总权益
```

- **< 60%**: ✅ 推荐（安全）
- **60-80%**: ⚠️ 超过安全水位（风险较高）
- **> 80%**: 🚫 资金紧张（极高风险）

### 风险评估标签

| 标签 | 状态 | 说明 |
|------|------|------|
| ✅ 推荐 (安全) | RECOMMENDED | 资金占用 < 60%，风险可控 |
| ⚠️ 超过安全水位 | HIGH_RISK | 资金占用 > 60%，风险较高 |
| 🚫 资金不足 | INSUFFICIENT_FUNDS | 可用余额不足 |
| ☠️ 爆仓预警 | HIGH_RISK | 爆仓价逼近现价 < 3% |
| ℹ️ 未检测资金 | RECOMMENDED | 未提供账户信息 |

### 爆仓价计算

系统会估算加仓后的新爆仓价：

```typescript
// 简化模型
buffer = (1 / leverage) - 0.005  // 10x → 9.5%

// Long
liquidationPrice = newAvgPrice × (1 - buffer)

// Short
liquidationPrice = newAvgPrice × (1 + buffer)
```

**预警**: 如果爆仓价距离现价 < 3%，系统会发出 ☠️ 爆仓预警。

---

## 📝 使用示例

### 示例 1: 查询当前价格

**用户**: "BTC现在多少钱？"

**AI 行为**:
1. 调用 `getBinanceMarketData`
2. 返回实时价格和24h统计

### 示例 2: 盈利策略建议

**用户**: "我在10万美元买了0.5个BTC，现在价格是9.5万，我想达到5000美元盈利，给我策略建议。账户余额2万美元，总权益3万美元。"

**AI 行为**:
1. 解析持仓信息
2. 调用 `planToAchieveProfitTarget`
3. 返回4-5个策略方案
4. 每个方案包含风控评估

### 示例 3: 百分比盈利

**用户**: "我总资金2,000,000，在90,000买了300,000仓位，92,000买了500,000仓位。我想盈利20%。"

**AI 行为**:
1. 计算已投入: 800,000
2. 计算目标: 800,000 × 20% = 160,000
3. 调用 `planToAchieveProfitTarget`
4. 返回策略方案

---

## 🔄 更新日志

### v2.0 (2025-11-20)
- ✅ 重构策略引擎为10x模式
- ✅ 添加60%安全水位线风控
- ✅ 统一所有单位为USD
- ✅ 明确盈利百分比计算规则
- ✅ 增强AI工具调用可靠性
- ✅ 添加爆仓价预警系统

### v1.0 (2025-11-15)
- 初始版本
- 基础策略引擎
- AI聊天集成

---

## 📞 支持

如有问题，请查看：
1. 本文档的[调试指南](#调试指南)部分
2. 检查服务器日志
3. 使用curl测试API端点

---

## 📄 许可证

Private - 内部使用

---

*文档维护者: AI Assistant*  
*项目路径: `/Users/user/Bitcoin 计算 - qifan/bc`*
