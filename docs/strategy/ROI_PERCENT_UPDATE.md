# ROI ç™¾åˆ†æ¯”åŠŸèƒ½æ›´æ–°

**æ›´æ–°æ—¶é—´**: 2025-11-21  
**ç‰ˆæœ¬**: v2.2  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ›´æ–°å†…å®¹

### æ ¸å¿ƒæ”¹åŠ¨ï¼šç›ˆåˆ©ç™¾åˆ†æ¯”åŸºäºå·²æŠ•å…¥æœ¬é‡‘ï¼ˆMarginï¼‰

ä¹‹å‰çš„é€»è¾‘é”™è¯¯åœ°å°†ç›ˆåˆ©ç™¾åˆ†æ¯”åº”ç”¨äº**ä»“ä½åä¹‰ä»·å€¼**æˆ–**æ€»èµ„é‡‘**ï¼Œç°åœ¨ä¿®æ­£ä¸ºåŸºäº**å·²æŠ•å…¥æœ¬é‡‘ï¼ˆMargin/ä¿è¯é‡‘ï¼‰**è®¡ç®—ã€‚

---

## ğŸ¯ å…³é”®æ¦‚å¿µ

### æ æ†äº¤æ˜“ä¸­çš„æœ¬é‡‘ vs ä»“ä½

| é¡¹ç›® | è¯´æ˜ | ç¤ºä¾‹ (10x æ æ†) |
|------|------|-----------------|
| **ä»“ä½åä¹‰ä»·å€¼** | äº¤æ˜“æ‰€æ˜¾ç¤ºçš„æŒä»“æ€»ä»·å€¼ | $800,000 |
| **å·²æŠ•å…¥æœ¬é‡‘ (Margin)** | å®é™…æ‰£æ¬¾çš„ä¿è¯é‡‘ | $80,000 |
| **æ æ†å€æ•°** | æ”¾å¤§å€æ•° | 10x |

**å…¬å¼**: `æœ¬é‡‘ (Margin) = ä»“ä½åä¹‰ä»·å€¼ / æ æ†å€æ•°`

---

## ğŸ”¥ æ–°å¢åŠŸèƒ½

### 1. æ–°å¢ `targetRoiPercent` å‚æ•°

åœ¨ `StrategyParams` æ¥å£ä¸­æ·»åŠ ï¼š

```typescript
interface StrategyParams {
  // ... åŸæœ‰å­—æ®µ ...
  targetRoiPercent?: number;  // ğŸ”¥ ç›®æ ‡ ROI % (åŸºäºå·²æŠ•å…¥æœ¬é‡‘ Margin)ï¼Œä¼˜å…ˆä½¿ç”¨
  targetProfitUSD?: number;   // ç›®æ ‡ç›ˆåˆ©é‡‘é¢ (USD)ï¼Œå…¼å®¹å›ºå®šé‡‘é¢
}
```

**ä¼˜å…ˆçº§**: `targetRoiPercent` > `targetProfitUSD`

---

### 2. ç­–ç•¥å¼•æ“è®¡ç®—é€»è¾‘

```typescript
// ğŸ”¥ 3. è®¡ç®—ç›®æ ‡ç›ˆåˆ© (ROI ä¼˜å…ˆ)
let targetProfitUSD = 0;
let targetDesc = "";

if (params.targetRoiPercent) {
  // åŸºäºå·²æŠ•å…¥æœ¬é‡‘ï¼ˆMarginï¼‰è®¡ç®—ç›®æ ‡ç›ˆåˆ©
  targetProfitUSD = currentMarginUsed * (params.targetRoiPercent / 100);
  targetDesc = `æœ¬é‡‘ ${params.targetRoiPercent}% ($${targetProfitUSD.toFixed(2)})`;
} else {
  // å…¼å®¹å›ºå®šé‡‘é¢æ¨¡å¼
  targetProfitUSD = params.targetProfitUSD || 0;
  targetDesc = `å›ºå®šé‡‘é¢ $${targetProfitUSD.toFixed(2)}`;
}
```

---

### 3. API å·¥å…·æ›´æ–°

#### planToAchieveProfitTarget å·¥å…·

æ–°å¢å‚æ•°ï¼š

```typescript
{
  targetRoiPercent: z.number().positive().optional()
    .describe('ğŸ”¥ Target ROI as percentage of invested MARGIN (e.g., 20 for 20% ROI). Takes priority over targetProfitUSD.'),
  targetProfitUSD: z.number().nonnegative().optional()
    .describe('Target profit amount in USD (fixed amount). Use targetRoiPercent instead for percentage-based targets.')
}
```

---

### 4. ç³»ç»Ÿæç¤ºæ›´æ–°

#### è‹±æ–‡æç¤ºï¼š

```
9. ğŸ”¥ CRITICAL: When user mentions profit percentage (e.g., "20% profit"), 
   use targetRoiPercent parameter based on INVESTED MARGIN (æœ¬é‡‘), 
   NOT total balance or notional value
   - ROI % is calculated on the MARGIN (ä¿è¯é‡‘) invested, not the leveraged position size
   - Example: 10x leverage position of $800,000 = $80,000 margin invested
   - If user wants 20% ROI â†’ use targetRoiPercent: 20 
     (which means 20% of $80,000 = $16,000 profit)
```

#### ä¸­æ–‡æç¤ºï¼š

```
9. ğŸ”¥ å…³é”®ï¼šå½“ç”¨æˆ·æåˆ°ç›ˆåˆ©ç™¾åˆ†æ¯”ï¼ˆå¦‚"ç›ˆåˆ©20%"ï¼‰æ—¶ï¼Œ
   ä½¿ç”¨ targetRoiPercent å‚æ•°ï¼ŒåŸºäºå·²æŠ•å…¥æœ¬é‡‘ï¼ˆMarginï¼‰ï¼Œ
   è€Œéæ€»ä½™é¢æˆ–ä»“ä½åä¹‰ä»·å€¼
   - ROI % æ˜¯åŸºäºæŠ•å…¥çš„ä¿è¯é‡‘ï¼ˆMarginï¼‰è®¡ç®—ï¼Œè€Œä¸æ˜¯æ æ†åçš„ä»“ä½å¤§å°
   - ç¤ºä¾‹ï¼š10x æ æ†ä»“ä½ $800,000 = æŠ•å…¥æœ¬é‡‘ $80,000
   - å¦‚æœç”¨æˆ·æƒ³è¦ 20% ROI â†’ ä½¿ç”¨ targetRoiPercent: 20
     ï¼ˆå³ $80,000 çš„ 20% = $16,000 ç›ˆåˆ©ï¼‰
```

---

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: å›ºå®šé‡‘é¢ç›ˆåˆ©

**ç”¨æˆ·è¾“å…¥**:
```
æˆ‘åœ¨10ä¸‡ç¾å…ƒä¹°äº†0.5ä¸ªBTCï¼Œç°åœ¨ä»·æ ¼æ˜¯9.5ä¸‡ï¼Œæˆ‘æƒ³è¾¾åˆ°5000ç¾å…ƒç›ˆåˆ©ã€‚
è´¦æˆ·ä½™é¢2ä¸‡ç¾å…ƒï¼Œæ€»æƒç›Š3ä¸‡ç¾å…ƒã€‚
```

**AI è°ƒç”¨**:
```json
{
  "symbol": "BTC",
  "position": {
    "direction": "long",
    "avgPrice": 100000,
    "qty": 0.5,
    "leverage": 10
  },
  "account": {
    "availableBalance": 20000,
    "totalWalletBalance": 30000
  },
  "targetProfitUSD": 5000
}
```

**è®¡ç®—**:
- ä»“ä½åä¹‰ä»·å€¼: $50,000
- å·²æŠ•å…¥æœ¬é‡‘: $5,000 (10x æ æ†)
- ç›®æ ‡ç›ˆåˆ©: $5,000 (å›ºå®šé‡‘é¢)

---

### ç¤ºä¾‹ 2: ç™¾åˆ†æ¯” ROIï¼ˆæœ¬é‡‘çš„ 20%ï¼‰

**ç”¨æˆ·è¾“å…¥**:
```
æˆ‘æ€»èµ„é‡‘2,000,000ï¼Œåœ¨90,000ä¹°äº†300,000ä»“ä½ï¼Œ92,000ä¹°äº†500,000ä»“ä½ã€‚
æˆ‘æƒ³ç›ˆåˆ©20%ã€‚
```

**AI è°ƒç”¨**:
```json
{
  "symbol": "BTC",
  "position": {
    "direction": "long",
    "avgPrice": 91250,
    "qty": 8.77,
    "leverage": 10
  },
  "account": {
    "availableBalance": 1200000,
    "totalWalletBalance": 2000000
  },
  "targetRoiPercent": 20
}
```

**è®¡ç®—**:
- ä»“ä½åä¹‰ä»·å€¼: $800,000 (300k + 500k)
- å·²æŠ•å…¥æœ¬é‡‘: $80,000 (10x æ æ†)
- ç›®æ ‡ç›ˆåˆ©: $16,000 (80k Ã— 20%)

**âœ… æ­£ç¡®**: 20% åŸºäºæœ¬é‡‘ $80,000 = $16,000  
**âŒ é”™è¯¯**: 20% åŸºäºä»“ä½ $800,000 = $160,000

---

## ğŸ”„ å¯¹æ¯”ï¼šä¿®æ”¹å‰ vs ä¿®æ”¹å

### åœºæ™¯ï¼šç”¨æˆ·æƒ³è¦ 20% ROI

| é¡¹ç›® | ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰ | ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰ |
|------|---------------|---------------|
| ä»“ä½åä¹‰ä»·å€¼ | $800,000 | $800,000 |
| æ æ†å€æ•° | 10x | 10x |
| å·²æŠ•å…¥æœ¬é‡‘ | $80,000 | $80,000 |
| **è®¡ç®—åŸºæ•°** | âŒ $800,000 (ä»“ä½) | âœ… $80,000 (æœ¬é‡‘) |
| **ç›®æ ‡ç›ˆåˆ©** | âŒ $160,000 | âœ… $16,000 |
| **å®é™… ROI** | 200% | 20% |

---

## ğŸ“ˆ è¾“å‡ºæ ¼å¼æ›´æ–°

### æ–°çš„æŠ¥å‘Šæ ‡é¢˜

```markdown
## ğŸ“Š ç­–ç•¥å¼•æ“åˆ†ææŠ¥å‘Š (ROI æ¨¡å¼)
```

### è´¦æˆ·ä¸ç›®æ ‡éƒ¨åˆ†

```markdown
### 1. è´¦æˆ·ä¸ç›®æ ‡
> **å·²æŠ•æœ¬é‡‘ (Margin)**: $80,000
> **å½“å‰æµ®äº**: $-7,855.90
> **ç›®æ ‡è®¾å®š**: **æœ¬é‡‘ 20% ($16,000.00)**
> **éœ€èµšå–é¢**: **$23,855.90**
> **æŒä»“æ€»é‡ (åä¹‰)**: $800,000
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1: ç™¾åˆ†æ¯” ROI

**è¾“å…¥**:
```bash
curl -X POST http://localhost:8081/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{
      "role": "user",
      "parts": [{
        "type": "text",
        "text": "æˆ‘æ€»èµ„é‡‘2,000,000ï¼Œåœ¨90,000ä¹°äº†300,000ä»“ä½ï¼Œ92,000ä¹°äº†500,000ä»“ä½ã€‚æˆ‘æƒ³ç›ˆåˆ©20%ã€‚"
      }]
    }],
    "language": "zh"
  }'
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "targetDescription": "æœ¬é‡‘ 20% ($16,000.00)",
  "currentStatus": {
    "marginUsed": "80,000.00"
  }
}
```

---

### æµ‹è¯• 2: å›ºå®šé‡‘é¢

**è¾“å…¥**:
```bash
curl -X POST http://localhost:8081/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{
      "role": "user",
      "parts": [{
        "type": "text",
        "text": "æˆ‘åœ¨10ä¸‡ç¾å…ƒä¹°äº†0.5ä¸ªBTCï¼Œæˆ‘æƒ³è¾¾åˆ°5000ç¾å…ƒç›ˆåˆ©ã€‚"
      }]
    }],
    "language": "zh"
  }'
```

**é¢„æœŸè¾“å‡º**:
```json
{
  "targetDescription": "å›ºå®šé‡‘é¢ $5,000.00",
  "currentStatus": {
    "marginUsed": "5,000.00"
  }
}
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶ï¼š

1. **`/app/lib/strategy-engine.ts`**
   - âœ… æ·»åŠ  `targetRoiPercent` å‚æ•°åˆ° `StrategyParams` æ¥å£
   - âœ… æ›´æ–° `generateStrategies` å‡½æ•°ï¼Œä¼˜å…ˆä½¿ç”¨ ROI ç™¾åˆ†æ¯”
   - âœ… æ·»åŠ  `targetDescription` åˆ°è¿”å›å€¼
   - âœ… æ›´æ–°è¾“å‡ºæ ¼å¼ï¼Œæ˜¾ç¤º"ROI æ¨¡å¼"å’Œç›®æ ‡è®¾å®š

2. **`/app/api/chat+api.ts`**
   - âœ… æ›´æ–° `planToAchieveProfitTarget` å·¥å…·ï¼Œæ·»åŠ  `targetRoiPercent` å‚æ•°
   - âœ… æ›´æ–°è‹±æ–‡ç³»ç»Ÿæç¤ºï¼Œè¯´æ˜ ROI è®¡ç®—åŸºäºæœ¬é‡‘
   - âœ… æ›´æ–°ä¸­æ–‡ç³»ç»Ÿæç¤ºï¼Œè¯´æ˜ ROI è®¡ç®—åŸºäºæœ¬é‡‘
   - âœ… æ›´æ–°ç¤ºä¾‹ï¼Œä½¿ç”¨ `targetRoiPercent` è€Œé `targetProfitUSD`

---

## âœ… å®ŒæˆçŠ¶æ€

- [x] æ·»åŠ  `targetRoiPercent` å‚æ•°
- [x] æ›´æ–°ç­–ç•¥å¼•æ“è®¡ç®—é€»è¾‘
- [x] æ›´æ–° API å·¥å…·å®šä¹‰
- [x] æ›´æ–°ç³»ç»Ÿæç¤ºï¼ˆè‹±æ–‡ + ä¸­æ–‡ï¼‰
- [x] æ›´æ–°è¾“å‡ºæ ¼å¼
- [x] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [x] ç¼–å†™æ–‡æ¡£

**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å‡†å¤‡æµ‹è¯•

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **æµ‹è¯•éªŒè¯**
   - æµ‹è¯•ç™¾åˆ†æ¯” ROI è®¡ç®—æ˜¯å¦æ­£ç¡®
   - æµ‹è¯•å›ºå®šé‡‘é¢æ¨¡å¼æ˜¯å¦å…¼å®¹
   - éªŒè¯ AI æ˜¯å¦æ­£ç¡®è°ƒç”¨ `targetRoiPercent`

2. **å¯é€‰ä¼˜åŒ–**
   - æ·»åŠ  ROI è®¡ç®—å™¨å·¥å…·
   - åœ¨ UI ä¸­æ˜¾ç¤ºæœ¬é‡‘ vs ä»“ä½å¯¹æ¯”
   - æ·»åŠ å†å² ROI è¿½è¸ª

---

*æœ€åæ›´æ–°: 2025-11-21*  
*ç»´æŠ¤è€…: AI Assistant*
